---
title: "SQL 활용(2)"
excerpt: "SQLD 정리"

categories:
  - Database
tags:
  - [tag1, tag2]

permalink: /database/sql/4_2

toc: true
toc_sticky: true

date: 2024-11-07
last_modified_at: 2024-11-08
---

## TOP N 쿼리

상위 N 순위까지를 추출하는 쿼리를 Top N 쿼리락고 한다.
기본적으로 순위함수를 사용해서 쿼리를 작성

### ROWNUM 함수
ROWNUM 함수는 ROW_NUMBER 함수와 달리 현재 저장된 데이터를 그대로 두고 각 행에 순차적인 번호를 붙여주는 함수.
- 테이블의 첫 행부터 차례로 순회
- 중간을 건너 뛸 수 없음
- WHERE절에 사용할 경우 조건식이 FALSE가 되면 순회를 멈추고 결과를 반환 

```sql
SELECT ROWNUM, EMPNI, ENAME, SAL
FROM EMP
WHERE ROWNUM <= 5;

-> 위에서 부터 5번째 까지 행들이 출력된다.
```
**[유의할 점]** <br/>

> ROWNUM에 대해 대소비교가 아닌 등식 비교를 하면 아무런 결과를 가져오지 못한다. <br/>
RUWNUM이 1일 때 조건이 FALSE가 되어 순회가 종료되기 때문

ROWNUM이 ORDER BY 절보다 먼저 수행되기 때문에 같이 쓰면 뒤죽박죽 출력된다.

-> 정렬을 수행한 후에 차례로 번호를 매기고 싶은 경우라면 ROW_NUMBER 을 사용

## 계층형 질의와 셀프 조인
계층형 모델에서 상위 노드(부모노드)에서 하위 노드(자식노드)로 연쇄적으로 데이터에 접근해서 결과를 조회해야 할 경우에
계층형 질의와 셀프 조인을 사용

### 계층형 질의
계층 구조를 가지는 칼럼을 대상으로 데이터를 출력할 때 사용할 수 있는 특별한 키워드를 제공
키워드를 사용하면 셀프 조인을 사용하지 않고 보다 단순하고 효율적인 쿼리를 작성할 수 있음
<br/>
**[키워드]**
- LEVEL : 전체 계층 구조에서 현재의 레벨 또는 깊이를 반환. 루트 노드가 1이 되며 한 레벨 내려갈 때마다 1씩 증가
- SYS_CONNECT_BY_PATH : 최상위 루트 노드로부터 현재 노드까지의 경로를 출력하는 함수
- START WITH : 경로의 시작이 되는 루트 노드가 되는 조건을 지정
- CONNECT BY : 부모 노드로부터 자식 노드로의 연결을 지정한다
- CONNECT_BY_ROOT : 루트 노드의 지정된 칼럼값을 반환한다
- CONNECT_BY_ISLEAF : 가장 말단 노드이면 1을 반환하고 그 외에는 0을 반환한다
- PRIOR : 바로 상위의 부모 노드를 반환한다
- NOCYCLE : 사이클 발생 이후의 데이터를 전개하지 않음으로써 무한 루프를 방지한다
- ORDER SIBLINGS BY : ORDER BY 절이 전체를 정렬하는 것에 비하여 ORDER SIBLINGS BY는 같은 레벨의 형제 노드끼리 정렬한다

> 계층 구조의 가장 말단 노드를 리프노드라고 한다.

> 데이터를 전개 시 데이터의 중복 발생이 나타날 경우 사이클이 형성되었다고 한다.

**[순방향 전개]** <br/>
CONNECT BY PRIOR 자식 = 부모 <br/>
상위 노드로 부모를 지정하므로 부모 -> 자식으로 이어지는 순방향 전개를 한다.

**[역방향 전개]** <br/>
CONNECT BY PRIOR 부모 = 자식 <br/>
상위 노드로 부모를 지정하므로 자식 -> 부모로 이어지는 역방향 전개를 한다.

### 셀프 조인
같은 테이블에 대해서 조인을 수행하는 경우를 셀프 조인이라고 한다.
- 계층적인 분류 값을 가지는 칼럼을 다룰 때
  - ex) 상품 분류, 주소 체계, 회사의 조직도 등
  
> 계층의 깊이가 깊어질수록 쿼리가 반복되고 길어짐 -> 계층형질의를 통해 해결

```sql
SELECT B.EMPNO, B.ENAME, B.JOB, A.ENAME AS BOSS, A.JOB AS BOSS_JOB
FROM EMP A, EMP B
WHERE A.EMPNO = B.MGR;
```

## PIVOT절과 UNPIVOT절

**PIVOT** : 테이블의 행과 열을 전환하여 테이블을 재구성하는 것
행과 열을 바꾸는 관점에 따라서 PIVOT, UNPIVOT을 구분한다.

### PIVOT
행을 열로 바꾼다. <br/>
지정된 칼럼의 각 행 속성값들이 새로운 칼럼 헤더가 되고 이에 맞게 전체 속성값들이 재배치된다.

### UNPIVOT
열을 행으로 바꾼다 <br/>
칼럼 헤더들이 한 칼럼의 각 행 속성값이 되고 이에 맞게 전체 속성값들이 재배치된다.

## 정규표현식

문자열을 처리할 때, 패턴에 기반하여 검색, 치환, 추출 등을 수행할 수 있다. <br/>
**메타문자** : 문자 그 자신이 가진 의미가 아니라 다른 의미로 사용되는 문자를 말한다.

- ₩ : 메타 문자를 리터럴 문자로 표시하거나 리터럴 문자와 결합하여 정해진 메타 문자를 표시
- ^ : 개행으로 나뉜 문자열의 시작 지점 -> ^The : The로 시작하는 문자열
- $ : 개행으로 나뉜 문자열의 끝지점 -> ing$ : ing으로 끝나는 문자열
- . : 임의의 한 문자(개행 문자는 제외)
- ? : 선행문자 0번 또는 1번 등장 -> no? : n, no 

- \* : 선행문자 0번 이상 등장 -> no* : n, no, noo, nooo, ...

- \+ : 선행문자 1번 이상 등장 -> no+ : no, noo, nooo, ...

- \| : 두 패턴 중 하나 선택 -> `a|b` : `a`, `b`

- [] : 괄호 안에 있는 문자들 중 하나와 일치 -> [abc] : a, b, c
- [^] : 괄호 안의 문자들을 제외한 나머지 문자들 중 하나와 일치 -> [^abc] : a,b,c를 제외한 나머지 문자
- () : 소괄호로 묶인 표현식을 한 단위로 취급 -> (ab) : ab

### 정규표현식 함수

- REGEXP_LIKE: 정규표현식을 사용한 LIKE 연산
- REGEXP_REPLACE: 문자열 대체
- REGEXP_INSTR: 문자열 검색 후 위치 반환
- REGEXP_SUBSTR: 부분 문자열 반환
- REGEXP_COUNT: 특정 패턴의 문자열 개수 반환


